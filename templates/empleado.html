<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Café Aroma - Empleado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Poppins', sans-serif; }
        
        .table-occupied { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .table-available { background: linear-gradient(135deg, #059669, #10b981); }
        .table-selected { background: linear-gradient(135deg, #d97706, #f59e0b); }
    </style>
</head>
<body class="bg-amber-50 min-h-screen">
    <!-- Aplicando header moderno con Tailwind CSS -->
    <header class="bg-white shadow-lg sticky top-0 z-40">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-coffee text-amber-600 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-amber-800">Café Aroma - Empleado</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span class="text-amber-800">Mesero: {{ nombre_mesero }}</span>
                    <a href="/logout" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </a>
                    <a href="/admin" class="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Admin
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Aplicando layout moderno con flexbox y Tailwind -->
    <div class="flex h-screen pt-20">
        <!-- Sección de Mesas -->
        <div class="flex-1 p-6 overflow-auto">
            <h2 class="text-2xl font-bold text-amber-800 mb-6">Seleccionar Mesa</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                {% for mesa in mesas_json %}
                <div class="{% if mesa.estado == 'Disponible' %}table-available{% else %}table-occupied{% endif %} text-white p-6 rounded-xl shadow-lg cursor-pointer hover:scale-105 transition-all" onclick="abrirModalProductos({{ mesa.id }})">
                    <div class="text-center">
                        <i class="fas fa-chair text-2xl mb-2"></i>
                        <p class="font-bold">Mesa {{ mesa.numero }}</p>
                        <p class="text-sm">{{ mesa.estado }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Sección de órdenes activas con diseño moderno -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-amber-800 mb-4">Órdenes Activas</h3>
                <div class="space-y-3">
                    {% for orden in ordenes_json %}
                    <div class="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                        <span class="font-medium text-amber-800">Orden #{{ orden.id }} - Mesa {{ orden.mesa_id }}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-amber-600">${{ "%.2f"|format(orden.total) }}</span>
                            <button onclick="verOrden({{ orden.id }})" class="bg-amber-600 text-white px-3 py-1 rounded-lg hover:bg-amber-700 text-sm">
                                Ver
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    {% if not ordenes_json %}
                    <p class="text-amber-600 text-center py-4">No hay órdenes activas.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Panel lateral de orden actual con diseño moderno -->
        <div class="w-96 bg-white shadow-2xl p-6">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-amber-800">Orden Actual</h3>
                <p id="mesa-actual" class="text-amber-600">Mesa: -</p>
            </div>
            
            <div class="flex-1 overflow-auto mb-4">
                <ul id="productos-orden" class="space-y-2">
                    <li class="text-amber-600 text-sm">No hay productos seleccionados</li>
                </ul>
            </div>
            
            <div class="border-t pt-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold text-amber-800">Total:</span>
                    <span id="total-orden" class="font-bold text-amber-800 text-lg">$0.00</span>
                </div>
                
                <button onclick="abrirModalPago()" class="w-full bg-amber-600 text-white py-3 rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                    Pagar Orden
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de productos con diseño moderno -->
    <div id="modal-productos" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="p-6 border-b border-amber-100">
                <h2 class="text-2xl font-bold text-amber-800">Seleccionar Productos - Mesa <span id="mesa-seleccionada"></span></h2>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                {% for categoria, productos in productos_por_categoria.items() %}
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-amber-800 mb-4">{{ categoria }}</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        {% for producto in productos %}
                        <div class="flex justify-between items-center p-4 bg-amber-50 rounded-lg">
                            <div>
                                <p class="font-medium text-amber-800">{{ producto.nombre }}</p>
                                <p class="text-amber-600">${{ "%.2f"|format(producto.precio) }}</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button onclick="restarCantidad({{ producto.id }})" class="bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600">-</button>
                                <span id="cantidad-{{ producto.id }}" class="font-bold text-amber-800 min-w-[20px] text-center">0</span>
                                <button onclick="sumarCantidad({{ producto.id }})" class="bg-green-500 text-white w-8 h-8 rounded-full hover:bg-green-600">+</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="p-6 border-t border-amber-100 flex space-x-4">
                <button onclick="crearOrden()" class="flex-1 bg-amber-600 text-white py-3 rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                    Crear Orden
                </button>
                <button onclick="cerrarModal('modal-productos')" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de pago con diseño moderno -->
    <div id="modal-pago" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
            <div class="p-6 border-b border-amber-100">
                <h2 class="text-2xl font-bold text-amber-800">Pagar Orden</h2>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-amber-800 font-medium mb-2">Método de pago</label>
                    <select id="metodo-pago" class="w-full px-4 py-3 border border-amber-200 rounded-lg focus:outline-none focus:border-amber-500">
                        <option value="">Seleccione método de pago</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Tarjeta">Tarjeta</option>
                        <option value="Transferencia">Transferencia</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-amber-800 font-medium mb-2">Correo para factura (opcional)</label>
                    <input type="email" id="correo-cliente" class="w-full px-4 py-3 border border-amber-200 rounded-lg focus:outline-none focus:border-amber-500" placeholder="correo@ejemplo.com">
                </div>
            </div>
            
            <div class="p-6 border-t border-amber-100 flex space-x-4">
                <button id="confirmar-pago-btn" class="flex-1 bg-amber-600 text-white py-3 rounded-lg font-semibold hover:bg-amber-700 transition-colors">
                    Confirmar Pago
                </button>
                <button onclick="cerrarModal('modal-pago')" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition-colors">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        let ordenActualId = null;
        let mesaSeleccionadaId = null;
        let productosSeleccionados = {};

        function abrirModalProductos(mesaId) {
            mesaSeleccionadaId = mesaId;
            document.getElementById('mesa-seleccionada').textContent = mesaId;
            document.getElementById('modal-productos').classList.remove('hidden');
            // Reiniciar cantidades
            productosSeleccionados = {};
            document.querySelectorAll('[id^="cantidad-"]').forEach(span => {
                span.textContent = '0';
            });
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function sumarCantidad(productoId) {
            productosSeleccionados[productoId] = (productosSeleccionados[productoId] || 0) + 1;
            document.getElementById(`cantidad-${productoId}`).textContent = productosSeleccionados[productoId];
        }

        function restarCantidad(productoId) {
            if (productosSeleccionados[productoId] > 0) {
                productosSeleccionados[productoId]--;
                document.getElementById(`cantidad-${productoId}`).textContent = productosSeleccionados[productoId];
            }
        }

        function crearOrden() {
            const productos = Object.keys(productosSeleccionados)
                .filter(id => productosSeleccionados[id] > 0)
                .map(id => ({ id: parseInt(id), cantidad: productosSeleccionados[id] }));
            if (!mesaSeleccionadaId || productos.length === 0) {
                alert('Seleccione una mesa y al menos un producto');
                return;
            }
            fetch('/empleado/orden/nueva', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mesa_id: mesaSeleccionadaId, productos })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Orden creada con éxito');
                    cerrarModal('modal-productos');
                    location.reload();
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al crear la orden');
            });
        }

        function verOrden(ordenId) {
            fetch(`/empleado/orden/${ordenId}/detalles`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar la orden');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const orden = data.orden;
                        document.getElementById('mesa-actual').textContent = `Mesa: ${orden.mesa_id}`;
                        const productosList = document.getElementById('productos-orden');
                        productosList.innerHTML = '';
                        orden.productos.forEach(producto => {
                            const li = document.createElement('li');
                            li.className = 'flex justify-between items-center text-sm p-2 bg-amber-50 rounded';
                            li.innerHTML = `
                                <span>${producto.nombre} x${producto.cantidad}</span>
                                <span>$${producto.subtotal.toFixed(2)}</span>
                            `;
                            productosList.appendChild(li);
                        });
                        document.getElementById('total-orden').textContent = `$${orden.total.toFixed(2)}`;
                        ordenActualId = orden.id;
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Hubo un error al ver la orden. Revisa la consola.');
                });
        }

        function abrirModalPago() {
            if (!ordenActualId) {
                alert('No hay orden seleccionada');
                return;
            }
            document.getElementById('modal-pago').classList.remove('hidden');
        }

        document.getElementById('confirmar-pago-btn').addEventListener('click', () => {
            const metodoPago = document.getElementById('metodo-pago').value;
            const correoCliente = document.getElementById('correo-cliente').value;
            if (!metodoPago) {
                alert('Seleccione un método de pago');
                return;
            }
            fetch(`/empleado/orden/${ordenActualId}/pagar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ metodo_pago: metodoPago, correo_cliente: correoCliente })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.mensaje);
                    cerrarModal('modal-pago');
                    location.reload();
                } else {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error en pago:', error);
                alert('Error al procesar el pago');
            });
        });
    </script>
</body>
</html>